<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS Song Archive & Database | サザンオールスターズ 楽曲データベース</title>
    <meta name="description" content="サザンオールスターズ、桑田佳祐、および関連アーティストの膨大な楽曲情報を網羅したアーカイブデータベース。テーマ別フィルタリングや検索が可能です。">
    <meta property="og:title" content="SAS Song Archive & Database">
    <meta property="og:description" content="サザンオールスターズ＆関連アーティストの楽曲データベース">
    <meta property="og:type" content="website">
    <link rel="stylesheet" href="style.css?v=2.0">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png" type="image/png">
    <meta name="theme-color" content="#0a0a0c">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed', err));
            });
        }
    </script>
</head>

<body>
    <div id="app" v-cloak>
        <header>
            <div class="logo-area">
                <div class="logo">
                    <i data-lucide="music"></i>
                    SAS ARCHIVE
                </div>
                <div class="subtitle">サザンオールスターズ＆関連アーティスト 楽曲データベース</div>
            </div>
            <div class="search-container">
                <input type="text" v-model="searchQuery" class="search-input" placeholder="曲名、アーティスト、歌詞で検索...">
            </div>
            <div class="header-right">
                <div class="stats">
                    <strong>{{ filteredSongs.length }}</strong> Tracks
                </div>
                <button class="random-btn" @click="pickRandomSong" title="ランダム選曲">
                    <i data-lucide="shuffle"></i><span>RANDOM</span>
                </button>
            </div>
        </header>

        <main>
            <div class="view-tabs">
                <button class="view-tab" :class="{ active: viewMode === 'songs' }" @click="viewMode = 'songs'"><i
                        data-lucide="music"></i> SONGS</button>
                <button class="view-tab" :class="{ active: viewMode === 'albums' }" @click="viewMode = 'albums'"><i
                        data-lucide="disc"></i> ALBUMS</button>
            </div>

            <div v-if="errorMsg" class="error-banner">
                <i data-lucide="alert-triangle"></i> {{ errorMsg }}
            </div>

            <div v-if="viewMode === 'songs' && selectedAlbumFilter" class="active-album-banner">
                <div style="display:flex; align-items:center; gap:8px;"><i data-lucide="disc"></i> 収録アルバム: <strong>{{
                        selectedAlbumFilter }}</strong></div>
                <button class="clear-btn" @click="clearAlbumFilter"><i data-lucide="x"></i> 絞り込み解除</button>
            </div>

            <div class="controls" v-show="viewMode === 'songs'">
                <div class="filter-row">
                    <div class="filter-group">
                        <span class="filter-label">Artist</span>
                        <div class="tag-scroll">
                            <div class="tag" :class="{ active: selectedArtist === '' }" @click="selectedArtist = ''">All
                            </div>
                            <div v-for="artist in allArtists" :key="artist" class="tag"
                                :class="{ active: selectedArtist === artist }" @click="selectedArtist = artist">
                                {{ artist }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-group">
                        <span class="filter-label">Themes</span>
                        <div class="tag-scroll">
                            <div class="tag" :class="{ active: selectedThemes.length === 0 }"
                                @click="selectedThemes = []">All</div>
                            <div v-for="theme in allThemes" :key="theme" class="tag"
                                :class="{ active: selectedThemes.includes(theme) }" @click="toggleTheme(theme)">
                                {{ theme }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-group">
                        <span class="filter-label">Mood</span>
                        <div class="tag-scroll">
                            <div class="tag" :class="{ active: selectedMood === '' }" @click="selectedMood = ''">All
                            </div>
                            <div v-for="mood in allMoods" :key="mood" class="tag"
                                :class="{ active: selectedMood === mood }" @click="selectedMood = mood">
                                {{ mood }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="filter-row bottom-row">
                    <div class="filter-group">
                        <span class="filter-label">Sort</span>
                        <div class="tag" :class="{ active: sortBy === 'year-desc' }" @click="sortBy = 'year-desc'">Newer
                        </div>
                        <div class="tag" :class="{ active: sortBy === 'year-asc' }" @click="sortBy = 'year-asc'">Older
                        </div>
                        <div class="tag" :class="{ active: sortBy === 'title' }" @click="sortBy = 'title'">A-Z</div>
                    </div>
                </div>
            </div>

            <div class="song-grid" v-show="viewMode === 'songs'">
                <div v-for="song in slicedSongs" :key="song.id" class="song-card" @click="openSong(song)">
                    <div class="year">{{ song.release_year }}</div>
                    <div class="title">{{ song.title }}</div>
                    <div class="artist">{{ song.artist }}</div>
                    <div class="themes">
                        <span v-if="song.mood" class="theme-badge"
                            style="background: rgba(251, 146, 60, 0.2); color: var(--accent-orange);">{{ song.mood
                            }}</span>
                        <span v-for="theme in song.themes" :key="theme" class="theme-badge">{{ theme }}</span>
                    </div>
                </div>
            </div>

            <div v-if="viewMode === 'albums'" class="album-grid">
                <div v-for="album in sortedAlbums" :key="album.title" class="album-card">
                    <a :href="getAmazonLink(album.songs[0].artist, album.title)" target="_blank"
                        rel="noopener noreferrer" class="album-image-link" title="Amazonで購入する">
                        <div v-if="album.image" class="album-cover"
                            :style="{ backgroundImage: 'url(' + album.image + ')' }">
                            <div class="amazon-overlay"><i data-lucide="shopping-cart"></i></div>
                        </div>
                        <div v-else class="album-icon"><i data-lucide="disc-3" style="width:40px; height:40px;"></i>
                        </div>
                    </a>
                    <div class="album-info" @click="filterByAlbum(album.title)" title="このアルバムの曲を見る"
                        style="cursor:pointer; width:100%; margin-top: 16px;">
                        <div class="album-title">{{ album.title }}</div>
                        <div class="album-date">{{ album.date }}</div>
                        <div class="album-category">{{ album.category }}</div>
                        <div class="album-tracks-badge">{{ album.songs.length }} Tracks <i data-lucide="chevron-right"
                                style="width:14px; height:14px; vertical-align:middle; margin-left: 4px;"></i></div>
                    </div>
                </div>
            </div>

            <div v-if="viewMode === 'songs' && filteredSongs.length > displayLimit"
                style="text-align: center; padding: 40px;">
                <button class="tag" @click="displayLimit += 48" style="padding: 12px 40px; font-size: 1rem;">Load
                    More</button>
            </div>
        </main>

        <footer>
            <div class="footer-content">
                <p>※ このサイトはサザンオールスターズのファンが個人的に制作したデータベースです。<br>
                    楽曲・歌詞の著作権はサザンオールスターズ、桑田佳祐、および各権利者に帰属します。</p>
                <div class="footer-bottom">
                    &copy; 2026 SAS ARCHIVE PROJECT
                </div>
            </div>
        </footer>

        <!-- Song Modal -->
        <transition name="fade">
            <div v-if="currentSong" class="modal-overlay" @click.self="currentSong = null">
                <div class="modal-content">
                    <button class="modal-close" @click="currentSong = null"><i data-lucide="x"></i></button>

                    <div style="text-align: center;">
                        <div class="year" style="color: var(--accent-blue); font-weight: 700; margin-bottom: 8px;">{{
                            currentSong.release_year }}</div>
                        <h2 style="font-size: 2.5rem; font-weight: 900; margin-bottom: 8px;">{{ currentSong.title }}
                        </h2>
                        <div style="font-size: 1.2rem; color: var(--text-secondary); margin-bottom: 24px;">{{
                            currentSong.artist }}</div>

                        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                            <span v-if="currentSong.mood" class="tag active"
                                style="background: var(--accent-orange); border-color: var(--accent-orange); cursor: default; pointer-events: none;">{{
                                currentSong.mood }}</span>
                            <span v-for="theme in currentSong.themes" :key="theme" class="tag active"
                                style="cursor: default; pointer-events: none;">{{ theme }}</span>
                        </div>
                    </div>

                    <div class="external-links">
                        <a :href="currentSong.links.lyrics" target="_blank" rel="noopener noreferrer"
                            class="link-btn lyrics-link">
                            <i data-lucide="music-4"></i> 歌詞を検索 (Uta-Net)
                        </a>
                        <a :href="currentSong.links.amazon" target="_blank" rel="noopener noreferrer"
                            class="link-btn amazon-link">
                            <i data-lucide="headphones"></i> Amazon Music
                        </a>
                        <a :href="currentSong.links.spotify" target="_blank" rel="noopener noreferrer"
                            class="link-btn spotify-link">
                            <i data-lucide="play-circle"></i> Spotify
                        </a>
                        <a :href="currentSong.links.apple" target="_blank" rel="noopener noreferrer"
                            class="link-btn apple-link">
                            <i data-lucide="music"></i> Apple Music
                        </a>
                        <a :href="currentSong.links.ytmusic" target="_blank" rel="noopener noreferrer"
                            class="link-btn ytmusic-link">
                            <i data-lucide="play"></i> YouTube Music
                        </a>
                        <a :href="currentSong.links.youtube" target="_blank" rel="noopener noreferrer"
                            class="link-btn youtube-link">
                            <i data-lucide="youtube"></i> YouTube 検索
                        </a>
                    </div>

                    <div class="album-list">
                        <h3 style="margin-bottom: 20px;">Included in</h3>
                        <a v-for="album in currentSong.albums" :key="album.title"
                            :href="getAmazonLink(currentSong.artist, album.title)" target="_blank"
                            rel="noopener noreferrer" class="album-item u-hover-zoom"
                            style="display: flex; gap: 16px; text-decoration: none; align-items: center; background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; transition: background 0.2s; border: 1px solid var(--border-color); margin-bottom: 12px;">
                            <div v-if="album.image" class="album-thumb"
                                :style="{ backgroundImage: 'url(' + album.image + ')' }"></div>
                            <div v-else class="album-icon-small"><i data-lucide="disc"></i></div>
                            <div style="flex: 1; text-align: left;">
                                <div style="color: var(--text-primary);"><span style="font-weight: 700;">{{ album.title
                                        }}</span>
                                    <span
                                        style="font-size: 0.8rem; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; margin-left:8px; color: var(--text-secondary);">{{
                                        album.category }}</span>
                                </div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 4px;">{{
                                    album.date }}</div>
                            </div>
                            <div
                                style="color: var(--accent-orange); display: flex; align-items: center; gap: 6px; font-size: 0.8rem; font-weight: bold;">
                                <i data-lucide="shopping-cart" style="width: 18px;"></i>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </transition>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const songs = ref([]);
                const searchQuery = ref('');
                const selectedThemes = ref([]);
                const selectedMood = ref('');
                const selectedAlbumFilter = ref('');
                const selectedArtist = ref('');
                const sortBy = ref('year-desc');
                const displayLimit = ref(48);
                const currentSong = ref(null);

                const allThemes = ref([]);
                const allMoods = ref([]);
                const allArtists = ref([]);
                const errorMsg = ref('');
                const viewMode = ref('songs');

                onMounted(async () => {
                    if (window.location.protocol === 'file:') {
                        errorMsg.value = '【注意】ローカル環境(file://)ではブラウザのセキュリティ制限によりデータファイルを読み込めません。VSCodeのLive Serverなどのローカルサーバー経由でアクセスしてください。';
                    }
                    try {
                        const response = await fetch('songs.json');
                        if (!response.ok) throw new Error('Network response was not ok');
                        songs.value = await response.json();

                        // Extract unique artists, exclude empty or Unknown, and apply custom order
                        const baseArtists = [...new Set(songs.value.map(s => s.artist_group))].filter(a => a && a !== 'Unknown');
                        const artistOrder = [
                            "サザンオールスターズ",
                            "桑田佳祐",
                            "原由子",
                            "松田弘",    // Assuming 松田浩 meant 松田弘 based on SAS members
                            "関口和之",
                            "KUWATA BAND"
                        ];

                        // Sort artists: ordered items first, then alphabetical, then OTHER at the absolute end
                        baseArtists.sort((a, b) => {
                            if (a === 'OTHER') return 1;
                            if (b === 'OTHER') return -1;

                            const indexA = artistOrder.indexOf(a);
                            const indexB = artistOrder.indexOf(b);

                            if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                            if (indexA !== -1) return -1;
                            if (indexB !== -1) return 1;

                            return a.localeCompare(b, 'ja');
                        });

                        allArtists.value = baseArtists;

                        // Extract unique themes dynamically
                        const themes = [...new Set(songs.value.flatMap(s => s.themes))].sort();
                        allThemes.value = themes;

                        const moods = [...new Set(songs.value.map(s => s.mood))].filter(Boolean);
                        allMoods.value = moods;

                        lucide.createIcons();
                    } catch (e) {
                        console.error('Failed to load songs:', e);
                        if (!errorMsg.value) {
                            errorMsg.value = 'データの読み込みに失敗しました。サーバーが起動しているか確認してください。';
                        }
                    }
                });

                watch(currentSong, (newVal) => {
                    if (newVal) {
                        setTimeout(() => lucide.createIcons(), 0);
                    }
                });

                const filteredSongs = computed(() => {
                    let result = songs.value;

                    if (searchQuery.value) {
                        const q = searchQuery.value.toLowerCase();
                        result = result.filter(s =>
                            s.title.toLowerCase().includes(q) ||
                            s.artist.toLowerCase().includes(q)
                        );
                    }

                    if (selectedThemes.value.length > 0) {
                        // AND filter: matches all of the selected themes
                        result = result.filter(s =>
                            selectedThemes.value.every(t => s.themes.includes(t))
                        );
                    }

                    if (selectedMood.value) {
                        result = result.filter(s => s.mood === selectedMood.value);
                    }

                    if (selectedAlbumFilter.value) {
                        result = result.filter(s => s.albums && s.albums.some(a => a.title === selectedAlbumFilter.value));
                    }

                    if (selectedArtist.value) {
                        result = result.filter(s => s.artist_group === selectedArtist.value);
                    }

                    // Sort
                    if (sortBy.value === 'year-desc') {
                        result.sort((a, b) => {
                            if (a.release_year === 'Unknown') return 1;
                            if (b.release_year === 'Unknown') return -1;
                            return b.release_year.localeCompare(a.release_year);
                        });
                    } else if (sortBy.value === 'year-asc') {
                        result.sort((a, b) => {
                            if (a.release_year === 'Unknown') return 1;
                            if (b.release_year === 'Unknown') return -1;
                            return a.release_year.localeCompare(b.release_year);
                        });
                    } else if (sortBy.value === 'title') {
                        result.sort((a, b) => a.title.localeCompare(b.title, 'ja'));
                    }

                    return result;
                });

                const slicedSongs = computed(() => filteredSongs.value.slice(0, displayLimit.value));

                const openSong = (song) => {
                    currentSong.value = song;
                };

                const toggleTheme = (theme) => {
                    const index = selectedThemes.value.indexOf(theme);
                    if (index > -1) {
                        selectedThemes.value.splice(index, 1);
                    } else {
                        selectedThemes.value.push(theme);
                    }
                };

                const pickRandomSong = () => {
                    if (filteredSongs.value.length === 0) return;
                    viewMode.value = 'songs'; // switch back to songs view to see the filtered list context
                    const randomIndex = Math.floor(Math.random() * filteredSongs.value.length);
                    openSong(filteredSongs.value[randomIndex]);
                };

                const filterByAlbum = (title) => {
                    selectedAlbumFilter.value = title;
                    viewMode.value = 'songs';
                };

                const clearAlbumFilter = () => {
                    selectedAlbumFilter.value = '';
                };

                const sortedAlbums = computed(() => {
                    const albumMap = new Map();
                    songs.value.forEach(s => {
                        if (s.albums) {
                            s.albums.forEach(a => {
                                if (!albumMap.has(a.title)) {
                                    albumMap.set(a.title, {
                                        title: a.title,
                                        date: a.date,
                                        category: a.category,
                                        image: a.image,
                                        songs: []
                                    });
                                }
                                albumMap.get(a.title).songs.push(s);
                            });
                        }
                    });
                    return Array.from(albumMap.values()).sort((a, b) => {
                        if (!a.date && !b.date) return 0;
                        if (!a.date) return 1;
                        if (!b.date) return -1;
                        return b.date.localeCompare(a.date);
                    });
                });

                const getAmazonLink = (artist, albumTitle) => {
                    const searchArtist = artist === 'OTHER' || artist === 'Unknown' ? 'サザンオールスターズ' : artist;
                    return `https://music.amazon.co.jp/search/${encodeURIComponent(searchArtist + ' ' + albumTitle)}?tag=sasfanjohnny-22`;
                };

                watch(viewMode, () => {
                    setTimeout(() => lucide.createIcons(), 0);
                });

                return {
                    songs,
                    searchQuery,
                    selectedThemes,
                    selectedMood,
                    selectedAlbumFilter,
                    selectedArtist,
                    sortBy,
                    displayLimit,
                    currentSong,
                    allThemes,
                    allMoods,
                    viewMode,
                    allArtists,
                    filteredSongs,
                    sortedAlbums,
                    slicedSongs,
                    openSong,
                    toggleTheme,
                    pickRandomSong,
                    filterByAlbum,
                    clearAlbumFilter,
                    getAmazonLink,
                    errorMsg
                };
            }
        }).mount('#app');
    </script>

    <style>
        [v-cloak] {
            display: none;
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        /* Modal scrollbar */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
    </style>
</body>

</html>